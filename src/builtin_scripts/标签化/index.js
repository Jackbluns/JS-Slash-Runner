function extract_tags_from(name){return[...name.matchAll(/【(.*?)】/g)].map((match=>match[1].toLowerCase()))}function extract_control_tags(){return function sortUnique(array){return _.sortedUniq(_.sortBy(array))}([...extract_tags_from($("#settings_preset_openai").find(":selected").text()),...$("#world_info").find(":selected").toArray().map((node=>$(node).text())).flatMap(extract_tags_from),...extract_tags_from($("#connection_profiles").find(":checked").text())])}function check_should_enable(title,tags){return[...title.matchAll(/【(.*?)】/g)].map((match=>match[1])).some((tag_list=>tag_list.split("&").map((tag=>tag.toLowerCase())).every((expected=>tags.includes(expected)))))}const toggle_tags_throttled=_.throttle((async function toggle_tags(){const tags=extract_control_tags();!async function toggle_tagged_preset_prompts(tags){const prompt_identifiers_to_be_toggled=$("#completion_prompt_manager").find("a[title]").filter((function(){return $(this).text().match(/【.*?】/)!==null})).toArray().map((prompt_anchor=>{const anchor=$(prompt_anchor),li=anchor.closest("li");return{identifier:li.attr("data-pm-identifier"),should_toggle:check_should_enable(anchor.attr("title"),tags)!==li.find(".prompt-manager-toggle-action").hasClass("fa-toggle-on")}})).filter((({should_toggle:should_toggle})=>should_toggle)).map((({identifier:identifier})=>`identifier=${identifier}`));prompt_identifiers_to_be_toggled.length!==0&&await triggerSlash(`/setpromptentry ${prompt_identifiers_to_be_toggled.join(" ")}`)}(tags),async function toggle_tagged_regexes(tags){const regexes=getTavernRegexes({scope:"all"}),new_regexes=_.cloneDeep(regexes);new_regexes.filter((regex=>regex.script_name.match(/【.*?】/)!==null)).forEach((regex=>{regex.enabled=check_should_enable(regex.script_name,tags)})),_.isEqual(regexes,new_regexes)||await replaceTavernRegexes(new_regexes,{scope:"all"})}(tags)}),1e3,{trailing:!1});$((()=>{toggle_tags_throttled(),eventMakeFirst(tavern_events.SETTINGS_UPDATED,toggle_tags_throttled)}));
